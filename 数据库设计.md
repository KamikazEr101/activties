# 数据库设计文档

## 一、设计原则

### 1.1 范式要求
- **遵循第三范式（3NF）**：
  - 第一范式（1NF）：所有字段不可再分，原子性。
  - 第二范式（2NF）：非主键字段完全依赖于主键。
  - 第三范式（3NF）：非主键字段不存在传递依赖。

### 1.2 外键策略
- **使用逻辑外键**：通过应用层代码维护数据一致性。
- **禁止物理外键**：避免锁表、性能问题和分库分表障碍。
- **索引策略**：在逻辑外键字段上建立普通索引以提升查询性能。

### 1.3 通用设计规范
- **字符集**：utf8mb4（支持emoji等4字节字符）。
- **排序规则**：utf8mb4_unicode_ci（不区分大小写）。
- **存储引擎**：InnoDB（支持事务、行级锁）。
- **主键策略**：使用BIGINT自增ID，预留足够增长空间。
- **时间字段**：统一使用DATETIME类型。
- **软删除**：使用is_deleted标记删除，保留历史数据。
- **审计字段**：create_time、update_time、creator_id。

---

## 二、数据库表设计

### 2.1 管理员表 (administrators)

**表说明**：存储系统管理员账号信息，区分超级管理员和普通管理员。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|---|---|---|---|---|---|
| id | BIGINT | 20 | NOT NULL | AUTO_INCREMENT | 管理员ID，主键 |
| username | VARCHAR | 50 | NOT NULL | - | 用户名（登录账号） |
| password | VARCHAR | 255 | NOT NULL | - | 密码（BCrypt加密） |
| real_name | VARCHAR | 50 | NOT NULL | - | 真实姓名 |
| phone | VARCHAR | 20 | NULL | - | 手机号码 |
| email | VARCHAR | 100 | NULL | - | 电子邮箱 |
| role_type | INT | 11 | NOT NULL | 1 | 角色：1-普通管理员, 2-超级管理员 |
| account_status | TINYINT | 1 | NOT NULL | 1 | 状态：0-禁用, 1-启用 |
| last_login_time | DATETIME | - | NULL | - | 最后登录时间 |
| is_deleted | TINYINT | 1 | NOT NULL | 0 | 软删除标记 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 记录创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 记录更新时间 |

**索引设计**：
```sql
PRIMARY KEY (id),
UNIQUE INDEX uk_username (username),
INDEX idx_role_status (role_type, account_status)
```

---

### 2.2 活动类型字典表 (activity_types)

**表说明**：活动类型字典表，便于管理和扩展活动类型。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|---|---|---|---|---|---|
| id | INT | 11 | NOT NULL | AUTO_INCREMENT | 类型ID，主键 |
| type_code | VARCHAR | 50 | NOT NULL | - | 类型编码 |
| type_name | VARCHAR | 50 | NOT NULL | - | 类型名称 |
| sort_order | INT | 11 | NOT NULL | 0 | 排序顺序 |
| is_enabled | TINYINT | 1 | NOT NULL | 1 | 是否启用：0-禁用, 1-启用 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 记录创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 记录更新时间 |

**索引设计**：
```sql
PRIMARY KEY (id),
UNIQUE INDEX uk_type_code (type_code)
```

---

### 2.3 活动表 (activities)

**表说明**：存储活动的完整信息。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|---|---|---|---|---|---|
| id | BIGINT | 20 | NOT NULL | AUTO_INCREMENT | 活动ID，主键 |
| activity_name | VARCHAR | 100 | NOT NULL | - | 活动名称 |
| activity_description | TEXT | - | NULL | - | 活动描述 |
| activity_type | VARCHAR | 50 | NOT NULL | 'OTHER' | 活动类型编码 (关联activity_types.type_code) |
| activity_status | TINYINT | 1 | NOT NULL | 0 | 状态：0-未发布, 1-报名中, 2-报名结束, 3-进行中, 4-已结束, 5-已取消 |
| start_time | DATETIME | - | NOT NULL | - | 活动开始时间 |
| end_time | DATETIME | - | NOT NULL | - | 活动结束时间 |
| location | VARCHAR | 200 | NOT NULL | - | 活动地点 |
| organizer | VARCHAR | 100 | NOT NULL | - | 主办方 |
| contact_person | VARCHAR | 50 | NOT NULL | - | 负责人姓名 |
| contact_phone | VARCHAR | 20 | NOT NULL | - | 联系电话 |
| poster_url | VARCHAR | 500 | NULL | - | 活动海报URL |
| max_participants | INT | 11 | NULL | - | 最大报名人数 (NULL为不限) |
| registration_start_time | DATETIME | - | NOT NULL | - | 报名开始时间 |
| registration_end_time | DATETIME | - | NOT NULL | - | 报名截止时间 |
| creator_id | BIGINT | 20 | NOT NULL | - | 创建者ID (关联administrators.id) |
| is_deleted | TINYINT | 1 | NOT NULL | 0 | 软删除标记 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 记录创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 记录更新时间 |

**索引设计**：
```sql
PRIMARY KEY (id),
INDEX idx_activity_name (activity_name),
INDEX idx_status_deleted (activity_status, is_deleted),
INDEX idx_start_time (start_time),
INDEX idx_creator_id (creator_id)
```

---

### 2.4 报名记录表 (registrations)

**表说明**：存储学生报名活动的记录。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|---|---|---|---|---|---|
| id | BIGINT | 20 | NOT NULL | AUTO_INCREMENT | 报名ID，主键 |
| activity_id | BIGINT | 20 | NOT NULL | - | 活动ID (关联activities.id) |
| student_name | VARCHAR | 50 | NOT NULL | - | 学生姓名 |
| student_phone | VARCHAR | 20 | NOT NULL | - | 学生手机号 |
| student_college | VARCHAR | 100 | NOT NULL | - | 学生学院 |
| registration_status | TINYINT | 1 | NOT NULL | 1 | 状态：1-报名成功, 2-已取消 |
| check_in_status | TINYINT | 1 | NOT NULL | 0 | 签到状态：0-未签到, 1-已签到 |
| check_in_time | DATETIME | - | NULL | - | 签到时间 |
| is_deleted | TINYINT | 1 | NOT NULL | 0 | 软删除标记 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 报名时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 记录更新时间 |

**索引设计**：
```sql
PRIMARY KEY (id),
UNIQUE INDEX uk_activity_phone_deleted (activity_id, student_phone, is_deleted),
INDEX idx_student_phone (student_phone)
```

---

## 三、表关系说明

### 3.1 逻辑外键关系

```
administrators (1) ----< (N) activities
    一个管理员可以创建多个活动
    关系字段：activities.creator_id -> administrators.id

activities (1) ----< (N) registrations
    一个活动可以有多个报名记录
    关系字段：registrations.activity_id -> activities.id

activity_types (1) ----< (N) activities
    一个活动类型可以对应多个活动
    关系字段：activities.activity_type -> activity_types.type_code
```

### 3.2 数据一致性保证
由于使用逻辑外键，需要在应用层保证数据一致性，主要通过事务控制、业务逻辑校验和软删除策略实现。

---

## 四、建表SQL脚本

### 4.1 创建数据库
```sql
CREATE DATABASE IF NOT EXISTS `activities_dev` 
DEFAULT CHARACTER SET utf8mb4 
DEFAULT COLLATE utf8mb4_unicode_ci;

USE `activities_dev`;
```

### 4.2 管理员表
```sql
DROP TABLE IF EXISTS `administrators`;
CREATE TABLE `administrators` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '管理员ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码（BCrypt加密）',
  `real_name` varchar(50) NOT NULL COMMENT '真实姓名',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号码',
  `email` varchar(100) DEFAULT NULL COMMENT '电子邮箱',
  `role_type` int(11) NOT NULL DEFAULT '1' COMMENT '角色：1-普通管理员, 2-超级管理员',
  `account_status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '状态：0-禁用, 1-启用',
  `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '软删除标记',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='管理员表';
```

### 4.3 活动类型字典表
```sql
DROP TABLE IF EXISTS `activity_types`;
CREATE TABLE `activity_types` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '类型ID',
  `type_code` varchar(50) NOT NULL COMMENT '类型编码',
  `type_name` varchar(50) NOT NULL COMMENT '类型名称',
  `sort_order` int(11) NOT NULL DEFAULT '0' COMMENT '排序顺序',
  `is_enabled` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用：0-禁用, 1-启用',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_code` (`type_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='活动类型字典表';
```

### 4.4 活动表
```sql
DROP TABLE IF EXISTS `activities`;
CREATE TABLE `activities` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '活动ID',
  `activity_name` varchar(100) NOT NULL COMMENT '活动名称',
  `activity_description` text COMMENT '活动描述',
  `activity_type` varchar(50) NOT NULL DEFAULT 'OTHER' COMMENT '活动类型编码',
  `activity_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态：0-未发布, 1-报名中, 2-报名结束, 3-进行中, 4-已结束, 5-已取消',
  `start_time` datetime NOT NULL COMMENT '活动开始时间',
  `end_time` datetime NOT NULL COMMENT '活动结束时间',
  `location` varchar(200) NOT NULL COMMENT '活动地点',
  `organizer` varchar(100) NOT NULL COMMENT '主办方',
  `contact_person` varchar(50) NOT NULL COMMENT '负责人姓名',
  `contact_phone` varchar(20) NOT NULL COMMENT '联系电话',
  `poster_url` varchar(500) DEFAULT NULL COMMENT '活动海报URL',
  `max_participants` int(11) DEFAULT NULL COMMENT '最大报名人数 (NULL为不限)',
  `registration_start_time` datetime NOT NULL COMMENT '报名开始时间',
  `registration_end_time` datetime NOT NULL COMMENT '报名截止时间',
  `creator_id` bigint(20) NOT NULL COMMENT '创建者ID',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '软删除标记',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_activity_name` (`activity_name`),
  KEY `idx_status_deleted` (`activity_status`, `is_deleted`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_creator_id` (`creator_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='活动表';
```

### 4.5 报名记录表
```sql
DROP TABLE IF EXISTS `registrations`;
CREATE TABLE `registrations` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '报名ID',
  `activity_id` bigint(20) NOT NULL COMMENT '活动ID',
  `student_name` varchar(50) NOT NULL COMMENT '学生姓名',
  `student_phone` varchar(20) NOT NULL COMMENT '学生手机号',
  `student_college` varchar(100) NOT NULL COMMENT '学生学院',
  `registration_status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '状态：1-报名成功, 2-已取消',
  `check_in_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '签到状态：0-未签到, 1-已签到',
  `check_in_time` datetime DEFAULT NULL COMMENT '签到时间',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '软删除标记',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '报名时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_activity_phone_deleted` (`activity_id`, `student_phone`, `is_deleted`),
  KEY `idx_student_phone` (`student_phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='报名记录表';
```

---

## 五、初始化数据

### 5.1 初始化活动类型
```sql
INSERT INTO `activity_types` (`type_code`, `type_name`, `sort_order`) VALUES
('ACADEMIC', '学术讲座', 1),
('SPORTS', '文体活动', 2),
('VOLUNTEER', '志愿服务', 3),
('CLUB', '社团活动', 4),
('COMPETITION', '竞赛活动', 5),
('OTHER', '其他', 99);
```

### 5.2 创建默认管理员账号
```sql
-- 密码：admin123 (注意：此密码为示例，插入数据库前必须由后端进行BCrypt加密)
-- BCrypt加密后的示例: $2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi

INSERT INTO `administrators` (`username`, `password`, `real_name`, `phone`, `email`, `role_type`, `account_status`) 
VALUES 
('superadmin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '超级管理员', '13800138000', 'super@example.com', 2, 1),
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '活动管理员', '13800138001', 'admin@example.com', 1, 1);
```

### 5.3 初始化活动数据
```sql
-- 注意：以下日期可能需要根据当前时间进行调整以保证状态的合理性。
-- 创建者ID `2` 对应上面创建的 'admin' 用户。
INSERT INTO `activities` (`activity_name`, `activity_description`, `activity_type`, `activity_status`, `start_time`, `end_time`, `location`, `organizer`, `contact_person`, `contact_phone`, `max_participants`, `registration_start_time`, `registration_end_time`, `creator_id`)
VALUES
('新生计算机基础讲座', '由计算机学院主办，面向全校新生的计算机入门讲座，内容涵盖常用软件使用、网络安全知识和编程入门介绍。', 'ACADEMIC', 1, '2024-09-15 19:00:00', '2024-09-15 21:00:00', '学术报告厅A201', '计算机学院', '王老师', '13812345678', 200, '2024-09-01 08:00:00', '2024-09-14 23:59:59', 2),
('校园篮球友谊赛', '为了丰富校园文化生活，增进各学院同学间的交流，特举办此次篮球友谊赛，欢迎大家踊跃报名或到场观战。', 'SPORTS', 0, '2024-10-12 14:00:00', '2024-10-12 17:00:00', '东区篮球场', '校学生会体育部', '李同学', '13787654321', NULL, '2024-09-20 08:00:00', '2024-10-10 23:59:59', 2),
('图书馆志愿者招募', '校图书馆现面向全校招募热心志愿者，参与图书整理、读者咨询等服务工作。服务时间可灵活安排，并计入志愿时长。', 'VOLUNTEER', 4, '2024-03-10 09:00:00', '2024-03-31 17:00:00', '中心图书馆', '校青年志愿者协会', '刘老师', '13611223344', 50, '2024-03-01 08:00:00', '2024-03-09 23:59:59', 2);
```

---

## 六、数据字典

### 6.1 活动状态枚举 (activity_status)
| 值 | 说明 |
|---|---|
| 0 | 未发布 |
| 1 | 报名中 |
| 2 | 报名结束 |
| 3 | 进行中 |
| 4 | 已结束 |
| 5 | 已取消 |

### 6.2 报名状态枚举 (registration_status)
| 值 | 说明 |
|---|---|
| 1 | 报名成功 |
| 2 | 已取消 |

### 6.3 签到状态枚举 (check_in_status)
| 值 | 说明 |
|---|---|
| 0 | 未签到 |
| 1 | 已签到 |

### 6.4 角色类型枚举 (role_type)
| 值 | 说明 |
|---|---|
| 1 | 普通管理员 |
| 2 | 超级管理员 |

### 6.5 账号状态枚举 (account_status)
| 值 | 说明 |
|---|---|
| 0 | 禁用 |
| 1 | 启用 |
